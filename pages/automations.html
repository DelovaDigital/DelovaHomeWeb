<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatiseringen - DelovaHome</title>
    <link rel="stylesheet" href="../style/base.css">
    <script>/* Prevent white flash */(function(){var t=localStorage.getItem('theme');if(t==='dark'){document.documentElement.style.background='#0f172a';document.documentElement.style.color='#f8fafc';if(document.body)document.body.style.background='#0f172a';}else{document.documentElement.style.background='#f8fafc';document.documentElement.style.color='#1e293b';if(document.body)document.body.style.background='#f8fafc';}})();</script>
    <script>(function(){var theme=localStorage.getItem('theme');var href=(theme==='dark'?'../style/style-dark.css':'../style/style.css');var l=document.createElement('link');l.rel='stylesheet';l.id='theme-stylesheet';l.href=href;document.head.appendChild(l);})();</script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Modern Logic Builder Styles */
        :root {
            --logic-if-bg: rgba(59, 130, 246, 0.1);
            --logic-if-border: rgba(59, 130, 246, 0.3);
            --logic-then-bg: rgba(16, 185, 129, 0.1);
            --logic-then-border: rgba(16, 185, 129, 0.3);
        }

        .automation-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-bottom: 15px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
        }
        .automation-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .automation-info h3 { margin: 0 0 5px 0; font-size: 1.1rem; }
        .automation-desc { color: var(--text-muted); font-size: 0.9rem; }
        .automation-actions { display: flex; gap: 10px; }
        
        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; top: 0; 
            width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
        }
        .modal-content {
            background-color: var(--card);
            margin: 2% auto; 
            padding: 0;
            border: 1px solid var(--border);
            border-radius: 24px;
            width: 95%; 
            max-width: 900px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.03);
        }
        
        .modal-body {
            padding: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .logic-section {
            padding: 30px;
            border-bottom: 1px solid var(--border);
        }

        .logic-header {
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .if-header { color: #60a5fa; }
        .then-header { color: #34d399; }

        .trigger-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .trigger-card {
            background: var(--bg-body);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            opacity: 0.7;
        }

        .trigger-card:hover { opacity: 1; transform: translateY(-2px); }
        .trigger-card.active {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
            opacity: 1;
        }
        .trigger-card i { font-size: 1.5rem; margin-bottom: 10px; display: block; }

        .action-builder {
            background: var(--logic-then-bg);
            border: 1px dashed var(--logic-then-border);
            padding: 20px;
            border-radius: 12px;
            min-height: 100px;
        }

        .action-item {
            background: var(--card);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .action-item:last-child { margin-bottom: 0; }

        .close { font-size: 24px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; }
        .close:hover { opacity: 1; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; opacity: 0.9; }
        .form-group select, .form-group input { 
            width: 100%; 
            padding: 10px 12px;
            border-radius: 8px;
            background: var(--bg-body);
            border: 1px solid var(--border);
            color: var(--text-main);
            font-size: 0.95rem;
        }
        .form-group select:focus, .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: rgba(255,255,255,0.03);
        }

        .config-box {
            background: var(--bg-body);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .section-name {
            padding: 30px;
            padding-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <nav class="main-nav">
            <!-- Navigation will be loaded here -->
        </nav>

        <main class="content-area">
            <header class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2>Automatiseringen</h2>
                    <p>Beheer slimme regels voor je huis</p>
                </div>
                <button class="btn btn-primary" onclick="openAutomationModal()">
                    <i class="fas fa-plus"></i> Nieuwe Automatisering
                </button>
            </header>

            <div id="automations-list">
                <!-- Automations will be loaded here -->
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                </div>
            </div>
        </main>
    </div>

    <!-- Automation Modal -->
    <div id="automationModal" class="modal">
        <form id="automationForm" class="modal-content" onsubmit="event.preventDefault(); saveAutomation();">
            <div class="modal-header">
                <h2 id="modalTitle" style="margin: 0; font-size: 1.5rem;">Nieuwe Automatisering</h2>
                <span class="close" onclick="closeAutomationModal()"><i class="fas fa-times"></i></span>
            </div>

            <div class="modal-body">
                <input type="hidden" id="automationId">
                <input type="hidden" id="triggerType" value="presence">
                
                <div class="section-name">
                    <div class="form-group">
                        <label>Naam van automatisering</label>
                        <input type="text" id="autoName" required placeholder="Bijv. Lichten uit bij vertrek" style="font-size: 1.1rem; padding: 12px;">
                    </div>
                </div>

                <!-- Step 1: WHEN -->
                <div class="logic-section" style="background: linear-gradient(to bottom, transparent, var(--logic-if-bg));">
                    <div class="logic-header if-header">
                        <i class="fas fa-bolt"></i> IF (Als dit gebeurt...)
                    </div>

                    <div class="trigger-cards">
                        <div class="trigger-card active" onclick="selectTriggerType('presence', this)">
                            <i class="fas fa-map-marker-alt" style="color: #60a5fa;"></i>
                            <div>Locatie</div>
                        </div>
                        <div class="trigger-card" onclick="selectTriggerType('time', this)">
                            <i class="fas fa-clock" style="color: #f59e0b;"></i>
                            <div>Tijd</div>
                        </div>
                        <div class="trigger-card" onclick="selectTriggerType('state', this)">
                            <i class="fas fa-toggle-on" style="color: #10b981;"></i>
                            <div>Apparaat Status</div>
                        </div>
                        <div class="trigger-card" onclick="selectTriggerType('weather', this)">
                            <i class="fas fa-cloud-sun" style="color: #6366f1;"></i>
                            <div>Weer</div>
                        </div>
                    </div>

                    <!-- Trigger Specific Fields -->
                    <div id="triggerFields" class="config-box">
                        <!-- Presence -->
                        <div id="trigger-presence" class="trigger-group">
                            <label>Gebeurtenis</label>
                            <select id="presenceEvent">
                                <option value="leave_home">Iedereen verlaat huis</option>
                                <option value="arrive_home">Iemand komt thuis</option>
                            </select>
                            <p style="margin-top: 10px; font-size: 0.85rem; color: var(--text-muted);">
                                Deze trigger gaat af wanneer de laatste persoon het huis verlaat of de eerste persoon thuiskomt.
                            </p>
                        </div>

                        <!-- Time -->
                        <div id="trigger-time" class="trigger-group" style="display:none;">
                            <label>Tijdstip (Uur:Minuut)</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="time" id="timeInput" onchange="updateCronFromTime(this.value)" style="max-width: 150px;">
                                <span style="font-size: 0.9rem; opacity: 0.7;">of</span>
                                <input type="text" id="timeCron" placeholder="Cron expressie (0 8 * * *)">
                            </div>
                        </div>

                        <!-- State -->
                        <div id="trigger-state" class="trigger-group" style="display:none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label>Apparaat</label>
                                    <select id="stateDevice"></select>
                                </div>
                                <div>
                                    <label>Eigenschap</label>
                                    <input type="text" id="stateProperty" value="on" placeholder="on, brightness">
                                </div>
                            </div>
                            <div style="margin-top: 12px;">
                                <label>Waarde is gelijk aan</label>
                                <input type="text" id="stateValue" placeholder="true, 100, etc.">
                            </div>
                        </div>

                        <!-- Weather -->
                        <div id="trigger-weather" class="trigger-group" style="display:none;">
                            <div class="form-group">
                                <label>Conditie</label>
                                <select id="weatherCondition">
                                    <option value="rain">Regen</option>
                                    <option value="snow">Sneeuw</option>
                                    <option value="clear">Helder</option>
                                    <option value="clouds">Bewolkt</option>
                                    <option value="temp_above">Temperatuur boven...</option>
                                    <option value="temp_below">Temperatuur onder...</option>
                                </select>
                            </div>
                            <div class="form-group" style="position: relative;">
                                <label>Locatie</label>
                                <!-- Uses autocomplete="new-password" hack to prevent browser address autofill -->
                                <input type="text" id="weatherLocation" name="weather_query_unique_id" placeholder="Typ stadnaam (bijv. Amsterdam)..." autocomplete="new-password" list="autocompleteOff" onkeydown="if(event.key === 'Enter') event.preventDefault();">
                                <input type="hidden" id="weatherLat">
                                <input type="hidden" id="weatherLon">
                                <div id="locationResults" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-body); border: 1px solid var(--border); border-radius: 8px; z-index: 100; max-height: 200px; overflow-y: auto; box-shadow: 0 10px 15px rgba(0,0,0,0.2);">
                                    <!-- Search results -->
                                </div>
                            </div>
                            <div id="weatherValueGroup" style="display: none; margin-top: 15px;">
                                <label>Waarde (Â°C)</label>
                                <input type="number" id="weatherValue" placeholder="20">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: THEN -->
                <div class="logic-section" style="background: linear-gradient(to bottom, transparent, var(--logic-then-bg));">
                    <div class="logic-header then-header" style="justify-content: space-between;">
                        <span><i class="fas fa-play-circle"></i> THEN (Doe dit...)</span>
                        
                        <div style="display: flex; gap: 8px;">
                            <button type="button" onclick="addDeviceAction()" title="Apparaat besturen" style="background: var(--card); border: 1px solid var(--border); padding: 8px 16px; border-radius: 8px; cursor: pointer; color: var(--text-main); display: flex; align-items: center; gap: 6px; font-weight: 500;">
                                <i class="fas fa-plus" style="color: #10b981;"></i> Apparaat
                            </button>
                            <button type="button" onclick="addDelayAction()" title="Wachttijd toevoegen" style="background: var(--card); border: 1px solid var(--border); padding: 8px 16px; border-radius: 8px; cursor: pointer; color: var(--text-main); display: flex; align-items: center; gap: 6px; font-weight: 500;">
                                <i class="fas fa-clock" style="color: #f59e0b;"></i> Wacht
                            </button>
                        </div>
                    </div>

                    <div id="actionsList" class="action-builder">
                        <div id="emptyActionsMsg" style="text-align: center; color: var(--text-muted); padding: 20px;">
                            Nog geen acties toegevoegd. Klik op + om te beginnen.
                        </div>
                        <!-- Actions will be added here -->
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn" style="background: transparent; border: 1px solid var(--border); color: var(--text-main);" onclick="closeAutomationModal()">Annuleren</button>
                <button type="submit" class="btn btn-primary" style="padding-left: 30px; padding-right: 30px;">
                    <i class="fas fa-save"></i> Opslaan
                </button>
            </div>
        </form>
    </div>

    <script src="../script/script.js"></script>
    <script src="../script/i18n.js"></script>
    <script src="../script/automations.js"></script>
</body>
</html>
